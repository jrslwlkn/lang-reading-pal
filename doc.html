<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0">
    <title>Liberrina - Lean a Language by Reading In It</title>
    <script src="https://unpkg.com/htmx.org@1.9.4"
            integrity="sha384-zUfuhFKKZCbHTY6aRR46gxiqszMk5tcHjsVFxnUo8VMus4kHGVdIYVbOYYNlKmHV"
            crossorigin="anonymous"></script>
    <link rel="stylesheet"
          href="https://necolas.github.io/normalize.css/8.0.1/normalize.css">
</head>
<style>
    #popup {
        position: absolute;
        display: none;
        background: lightgrey;
        padding: 10px;
        margin: 20px;
        box-shadow: 3px 3px 10px gray;
        border: none;
    }

    article {
        max-width: 800px;
        margin: 20px auto;
        line-height: 2;
        font-size: 1.2rem;
        cursor: default;
    }

    nav {
        display: flex;
        margin: 20px;
        justify-content: end;
    }

    input[type=number] {
        width: 3rem;
    }
</style>

<body>
    <dialog id="popup">
    </dialog>

    <nav>
        <div>
            <label for="text_font_size">Font size:</label>
            <input name="text_font_size"
                   type="number"
                   min="9"
                   max="69"
                   oninput="handleFontSizeChange(this.valueAsNumber)">
        </div>
    </nav>

    <article>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et
        dolore<br> magna aliqua. Adipiscing commodo elit at imperdiet dui accumsan sit amet. Commodo quis imperdiet
        massa tincidunt<br> nunc pulvinar sapien. Aenean sed adipiscing diam donec adipiscing tristique risus. Purus
        gravida quis blandit<br> turpis cursus. Turpis egestas maecenas pharetra convallis posuere morbi leo. Ultrices
        dui sapien eget mi proin.<br> Nunc id cursus metus aliquam eleifend. Dictum non consectetur a erat. Urna id
        volutpat lacus laoreet non<br> curabitur gravida arcu. Quis viverra nibh cras pulvinar mattis nunc sed
        blandit.<br> Velit euismod in pellentesque massa placerat duis ultricies lacus. Mi eget mauris pharetra et.
        Lorem ipsum dolor<br> sit amet. Mauris commodo quis imperdiet massa tincidunt nunc pulvinar sapien. Sed felis
        eget velit aliquet<br> sagittis. Id interdum velit laoreet id donec. Mauris rhoncus aenean vel elit scelerisque
        mauris pellentesque<br> pulvinar pellentesque. Sit amet consectetur adipiscing elit duis. Nibh praesent
        tristique magna sit amet.<br> Gravida quis blandit turpis cursus.<br><br> Vulputate sapien nec sagittis aliquam
        malesuada bibendum arcu vitae elementum. In cursus turpis massa tincidunt dui ut. Etiam non quam lacus
        suspendisse faucibus interdum posuere. Mauris sit amet massa vitae tortor condimentum lacinia quis vel.
        Pellentesque elit eget gravida cum sociis natoque penatibus et. Ac tortor dignissim convallis aenean et tortor
        at. Sit amet justo donec enim diam. Dolor sit amet consectetur adipiscing. Tincidunt nunc pulvinar sapien et
        ligula. Adipiscing commodo elit at imperdiet dui. Tincidunt id aliquet risus feugiat in.<br><br> Nec dui nunc
        mattis enim ut tellus elementum sagittis. Mus mauris vitae ultricies leo integer malesuada.<br> Vulputate odio
        ut enim blandit volutpat maecenas volutpat. Volutpat sed cras ornare arcu dui vivamus arcu felis.<br> Amet nulla
        facilisi morbi tempus. Ornare lectus sit amet est. Amet volutpat consequat mauris nunc congue nisi.<br> Nisi
        porta lorem mollis aliquam ut. Cursus vitae congue mauris rhoncus aenean vel elit scelerisque mauris.<br> Tempus
        iaculis urna id volutpat lacus laoreet. Scelerisque felis imperdiet proin fermentum leo vel. In est ante<br> in
        nibh mauris cursus mattis molestie. Eu turpis egestas pretium aenean. Quisque egestas diam in arcu. Sit amet<br>
        aliquam id diam maecenas ultricies. Diam quam nulla porttitor massa id. Tortor at risus viverra adipiscing
        at.<br> Facilisi nullam vehicula ipsum a arcu.<br><br> Enim blandit volutpat maecenas volutpat blandit aliquam
        etiam. Duis at consectetur lorem donec massa. Risus<br> viverra adipiscing at in tellus integer feugiat. Cum
        sociis natoque penatibus et magnis dis parturient. Nibh<br> ipsum consequat nisl vel pretium lectus. Volutpat
        diam ut venenatis tellus in metus vulputate eu. Sed lectus<br> vestibulum mattis ullamcorper velit sed
        ullamcorper morbi tincidunt. At in tellus integer feugiat scelerisque<br> varius morbi. Ultrices mi tempus
        imperdiet nulla malesuada pellentesque elit. Convallis convallis tellus id<br> interdum velit laoreet id. Sed
        blandit libero volutpat sed cras. In nulla posuere sollicitudin aliquam ultrices.<br> Dictum fusce ut placerat
        orci nulla pellentesque dignissim enim. At urna condimentum mattis pellentesque id<br> nibh. Massa tempor nec
        feugiat nisl pretium fusce id velit ut. Mattis vulputate enim nulla aliquet porttitor.<br> Massa id neque
        aliquam vestibulum morbi. Arcu ac tortor dignissim convallis aenean et. Amet purus gravida quis<br> blandit
        turpis cursus.<br><br>
    </article>
</body>

<script>
    let popupId = null;
    const popup = document.getElementById("popup");
    const textSizeInput = document.querySelector("input[name=text_font_size]");
    const article = document.querySelector("article");

    handleFontSizeChange(localStorage.getItem("text_font_size") ?? "12");

    function getSelectionString() {
        return document.getSelection().toString()
    }

    function openPopup(e) {
        if (!getSelectionString())
            return;
        const newId = setTimeout(() => {
            if (popupId == newId && getSelectionString()) {
                popup.style.left = e.pageX + 'px';
                popup.style.top = e.pageY + 'px';
                popup.style.display = 'block';
                popup.innerText = getSelectionString();
            }
            clearTimeout(newId);
        }, 1000);
        popupId = newId;
    }

    function closePopup() {
        popup.style.display = 'none';
    }

    function handleFontSizeChange(size) {
        localStorage.setItem("text_font_size", size);
        article.style.fontSize = size + "px";
    }

    document.addEventListener('mouseup', openPopup);
    document.addEventListener('keydown', e => e.key == "Escape" && closePopup());
    document.addEventListener('click', e => !popup.contains(e.target) && closePopup());
</script>

</html>
